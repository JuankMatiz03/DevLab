<mat-card class="card">
  <mat-card-header>
    <mat-icon mat-card-avatar aria-hidden="true">add_shopping_cart</mat-icon>
    <mat-card-title>Crear factura</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <div class="grid">
      <mat-form-field appearance="outline" class="full">
        <mat-label>Número</mat-label>
        <input
          matInput
          type="number"
          [ngModel]="number()"
          (ngModelChange)="number.set($event)"
          min="1"
          placeholder="Ej: 1001" 
        />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Cliente</mat-label>
        <mat-select 
          [ngModel]="customerId()"
          (ngModelChange)="customerId.set($event); resetSearch();"
        >
          <mat-option [value]="null">— seleccione el cliente —</mat-option>
          <mat-option *ngFor="let c of customers()" [value]="c.id">{{ c.name }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </mat-card-content>

  <mat-card-actions class="actions">
    <button mat-flat-button color="primary" (click)="addRow()">
      <mat-icon>add</mat-icon>
      Agregar producto
    </button>

    <button mat-stroked-button color="primary" (click)="newInvoice()">
      <mat-icon>refresh</mat-icon>
      Nuevo
    </button>
  </mat-card-actions>

  <mat-divider></mat-divider>

  <mat-card-content class="table-wrapper" *ngIf="rows().length > 0;">
    <div class="table-toolbar">
      <mat-form-field appearance="outline" class="filter">
        <mat-label>Filtrar productos</mat-label>
        <input 
          matInput 
          (keyup)="applyFilter($event)" 
          placeholder="Nombre, precio, cantidad..." 
        />
        <button *ngIf="dataSource.filter" matSuffix mat-icon-button (click)="clearFilter()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
    </div>
    
    <div class="custom-table">

      <table 
        mat-table 
        [dataSource]="dataSource" 
        matSort 
        class="mat-elevation-z2 mat-table form-table"
      >

        <ng-container matColumnDef="product">
          <th mat-header-cell *matHeaderCellDef>Producto</th>
          <td mat-cell *matCellDef="let r">
            <mat-form-field appearance="outline" class="field-in-table">
              <mat-select
                [ngModel]="r.productId"
                (ngModelChange)="r.productId = $event; onProductChange(r)"
              >
                <mat-option *ngFor="let p of products()" [value]="p.id">{{ p.name }}</mat-option>
              </mat-select>
            </mat-form-field>
          </td>
        </ng-container>

        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef class="right" mat-sort-header>Precio</th>
          <td mat-cell *matCellDef="let r" class="right">
            <mat-form-field appearance="outline" class="field-in-table narrow">
              <input
                matInput
                type="number"
                step="0.01"
                [ngModel]="r.price"
                (ngModelChange)="r.price = $event; recalc(r)" 
              />
            </mat-form-field>
          </td>
        </ng-container>

        <ng-container matColumnDef="qty">
          <th mat-header-cell *matHeaderCellDef class="right" mat-sort-header>Cant.</th>
          <td mat-cell *matCellDef="let r" class="right">
            <mat-form-field appearance="outline" class="field-in-table narrow">
              <input
                matInput
                type="number"
                min="1"
                [ngModel]="r.qty"
                (ngModelChange)="r.qty = $event; recalc(r)" 
              />
            </mat-form-field>
          </td>
        </ng-container>

        <ng-container matColumnDef="image">
          <th mat-header-cell *matHeaderCellDef>Imagen</th>
          <td mat-cell *matCellDef="let r">
            <img 
              class="prod-img" 
              [src]="r.imageUrl || 'https://placehold.co/40x40?text=+'" 
              alt="" 
            />
          </td>
        </ng-container>

        <ng-container matColumnDef="lineTotal">
          <th mat-header-cell *matHeaderCellDef class="right" mat-sort-header>Total</th>
          <td mat-cell *matCellDef="let r" class="right strong">
            {{ r.lineTotal | currency:'COP':'symbol-narrow':'1.0-0' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let r; let i = index" class="center">
            <button mat-icon-button color="warn" (click)="removeRow(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row        *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <mat-paginator
        class="paginator"
        [pageSize]="5"
        [pageSizeOptions]="[5,10,20,50]"
        showFirstLastButtons
      />
    </div>
  </mat-card-content>

  <mat-card-content class="summary" *ngIf="rows().length > 0">
    <div class="pill">
      Subtotal: <b>{{ subtotal() | currency:'COP':'symbol-narrow':'1.0-0' }}</b>
    </div>
    <div class="pill">
      IVA (19%): <b>{{ tax()      | currency:'COP':'symbol-narrow':'1.0-0' }}</b>
    </div>
    <div class="pill highlight">
      Total: <b>{{ total()   | currency:'COP':'symbol-narrow':'1.0-0' }}</b>
    </div>
  </mat-card-content>

  <mat-card-actions align="end" class="save">
    <button
      mat-flat-button
      color="accent"
      (click)="save()"
    >
      <mat-icon>save</mat-icon>
      Guardar
    </button>
  </mat-card-actions>
</mat-card>
